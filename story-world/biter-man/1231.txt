import React, { useState, useEffect, useRef, useMemo } from 'react';
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.164.0/build/three.module.js';
import { Sparkles, Send, Trash2, Zap, Trophy, History } from 'lucide-react';

/**
 * FIREWORK FAREWELL - PRODUCTION V1 (Vertical Slice)
 * * CORE LOOP:
 * 1. Input "Old Pattern" (Negative)
 * 2. Input "Intention" (Positive)
 * 3. Physics Launch -> 3D Peak -> Explosion -> Label Transformation
 * 4. Gamified Rewards (Glow Points + Streaks)
 */

const App = () => {
  // --- STATE ---
  const [negative, setNegative] = useState('');
  const [positive, setPositive] = useState('');
  const [score, setScore] = useState(() => Number(localStorage.getItem('ff_score') || 0));
  const [streak, setStreak] = useState(0);
  const [bestStreak, setBestStreak] = useState(() => Number(localStorage.getItem('ff_bestStreak') || 0));
  
  // Refs for Three.js bridge
  const canvasRef = useRef(null);
  const requestRef = useRef();
  const sceneRef = useRef({
    scene: null,
    camera: null,
    renderer: null,
    rockets: [],
    explosions: [],
    labels: [],
    stars: null
  });

  // --- PERSISTENCE ---
  useEffect(() => {
    localStorage.setItem('ff_score', score);
  }, [score]);

  useEffect(() => {
    if (streak > bestStreak) {
      setBestStreak(streak);
      localStorage.setItem('ff_bestStreak', streak);
    }
  }, [streak, bestStreak]);

  // --- THREE.JS INITIALIZATION ---
  useEffect(() => {
    const scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x02020a, 0.03);

    const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 200);
    camera.position.set(0, 4, 12);

    const renderer = new THREE.WebGLRenderer({ 
      canvas: canvasRef.current, 
      antialias: true,
      alpha: true 
    });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setClearColor(0x000000, 0);

    // Environment
    const hemiLight = new THREE.HemisphereLight(0x4455ff, 0x000000, 0.8);
    scene.add(hemiLight);

    const starGeo = new THREE.BufferGeometry();
    const starCount = 1000;
    const starPos = new Float32Array(starCount * 3);
    for (let i = 0; i < starCount; i++) {
      starPos[i * 3 + 0] = (Math.random() - 0.5) * 60;
      starPos[i * 3 + 1] = 2 + Math.random() * 20;
      starPos[i * 3 + 2] = (Math.random() - 0.5) * 60;
    }
    starGeo.setAttribute('position', new THREE.BufferAttribute(starPos, 3));
    const starMat = new THREE.PointsMaterial({ color: 0x8888ff, size: 0.04, transparent: true, opacity: 0.5 });
    const stars = new THREE.Points(starGeo, starMat);
    scene.add(stars);

    sceneRef.current = { ...sceneRef.current, scene, camera, renderer, stars };

    const animate = () => {
      const delta = 0.016; // Approx 60fps
      
      // Update Rockets
      sceneRef.current.rockets = sceneRef.current.rockets.filter(r => {
        r.age += delta;
        r.velocity.y += -5.5 * delta;
        r.mesh.position.addScaledVector(r.velocity, delta);
        r.mesh.rotation.x += delta * 5;
        
        if (r.velocity.y <= 0 || r.age >= r.maxAge) {
          spawnExplosion(r.mesh.position, r.colors);
          createLabel(r.mesh.position, r.negativeText, r.positiveText);
          scene.remove(r.mesh);
          return false;
        }
        return true;
      });

      // Update Explosions
      sceneRef.current.explosions = sceneRef.current.explosions.filter(e => {
        e.age += delta;
        const t = e.age / e.maxAge;
        const posAttr = e.points.geometry.attributes.position;
        for (let i = 0; i < e.velocities.length; i++) {
          e.velocities[i].y += -3.5 * delta;
          posAttr.array[i * 3 + 0] += e.velocities[i].x * delta;
          posAttr.array[i * 3 + 1] += e.velocities[i].y * delta;
          posAttr.array[i * 3 + 2] += e.velocities[i].z * delta;
        }
        posAttr.needsUpdate = true;
        e.points.material.opacity = 1 - t;
        if (e.age >= e.maxAge) {
          scene.remove(e.points);
          return false;
        }
        return true;
      });

      // Update Label Positions (Drift)
      sceneRef.current.labels = sceneRef.current.labels.filter(l => {
        l.age += delta;
        l.position.y += delta * 0.3;
        const screen = toScreenPosition(l.position, camera);
        l.element.style.left = `${screen.x}px`;
        l.element.style.top = `${screen.y}px`;
        const t = l.age / l.maxAge;
        l.element.style.opacity = t < 0.7 ? 1 : 1 - (t - 0.7) / 0.3;
        if (l.age >= l.maxAge) {
          l.element.remove();
          return false;
        }
        return true;
      });

      stars.rotation.y += 0.0005;
      renderer.render(scene, camera);
      requestRef.current = requestAnimationFrame(animate);
    };

    requestRef.current = requestAnimationFrame(animate);

    const handleResize = () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    };
    window.addEventListener('resize', handleResize);

    return () => {
      window.removeEventListener('resize', handleResize);
      cancelAnimationFrame(requestRef.current);
    };
  }, []);

  // --- UTILS ---
  const toScreenPosition = (vector3, camera) => {
    const v = vector3.clone();
    v.project(camera);
    return {
      x: (v.x * 0.5 + 0.5) * window.innerWidth,
      y: (-v.y * 0.5 + 0.5) * window.innerHeight
    };
  };

  const spawnExplosion = (position, colors) => {
    const count = 150;
    const geo = new THREE.BufferGeometry();
    const pos = new Float32Array(count * 3);
    const vels = [];
    for (let i = 0; i < count; i++) {
      const theta = Math.random() * Math.PI * 2;
      const phi = Math.acos(2 * Math.random() - 1);
      const speed = 2 + Math.random() * 4;
      vels.push(new THREE.Vector3(
        Math.sin(phi) * Math.cos(theta) * speed,
        Math.cos(phi) * speed,
        Math.sin(phi) * Math.sin(theta) * speed
      ));
      pos[i * 3 + 0] = position.x;
      pos[i * 3 + 1] = position.y;
      pos[i * 3 + 2] = position.z;
    }
    geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
    const mat = new THREE.PointsMaterial({ color: colors.positive, size: 0.07, transparent: true, opacity: 1 });
    const points = new THREE.Points(geo, mat);
    sceneRef.current.scene.add(points);
    sceneRef.current.explosions.push({ points, velocities: vels, age: 0, maxAge: 3.0 });
  };

  const createLabel = (position, negText, posText) => {
    const div = document.createElement('div');
    div.className = 'absolute pointer-events-none text-center transform -translate-x-1/2 -translate-y-1/2 select-none z-50';
    div.innerHTML = `
      <div class="text-pink-500 line-through opacity-60 text-xs italic blur-[0.5px]">${negText}</div>
      <div class="text-yellow-200 font-bold text-sm tracking-wide drop-shadow-[0_0_8px_rgba(255,255,255,0.8)] mt-1">${posText}</div>
    `;
    document.getElementById('label-layer').appendChild(div);
    sceneRef.current.labels.push({ element: div, position: position.clone(), age: 0, maxAge: 5.0 });
  };

  // --- ACTIONS ---
  const handleLaunch = () => {
    if (!negative.trim() || !positive.trim()) {
      setStreak(0);
      return;
    }

    const { scene, rockets } = sceneRef.current;
    const pair = [
      { negative: 0xff3355, positive: 0xfff08a },
      { negative: 0xff4b92, positive: 0x7cf9ff },
      { negative: 0x48f5ff, positive: 0xffffff }
    ][Math.floor(Math.random() * 3)];

    const rocketGeo = new THREE.CylinderGeometry(0.05, 0.05, 0.8, 8);
    const rocketMat = new THREE.MeshStandardMaterial({ color: pair.negative, emissive: pair.negative, emissiveIntensity: 1 });
    const mesh = new THREE.Mesh(rocketGeo, rocketMat);
    
    const x = (Math.random() - 0.5) * 12;
    const z = (Math.random() - 0.5) * 8;
    mesh.position.set(x, -2, z);

    rockets.push({
      mesh,
      velocity: new THREE.Vector3((Math.random() - 0.5) * 0.5, 4.5 + Math.random(), (Math.random() - 0.5) * 0.5),
      age: 0,
      maxAge: 1.5 + Math.random() * 0.5,
      negativeText: negative,
      positiveText: positive,
      colors: pair
    });

    scene.add(mesh);
    
    // Reward
    setScore(s => s + 10);
    setStreak(s => s + 1);
    setNegative('');
    setPositive('');
  };

  return (
    <div className="relative w-full h-screen bg-[#02020a] overflow-hidden font-sans text-slate-100 selection:bg-purple-500/30">
      {/* 3D Scene */}
      <canvas ref={canvasRef} className="absolute inset-0 z-0" />
      
      {/* Text Label Layer */}
      <div id="label-layer" className="absolute inset-0 z-10 pointer-events-none" />

      {/* UI Overlay */}
      <main className="relative z-20 w-full h-full flex flex-col items-center justify-between p-6 pointer-events-none">
        
        {/* Header & Stats */}
        <header className="w-full max-w-2xl flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
          <div>
            <h1 className="text-2xl font-black tracking-tighter uppercase italic flex items-center gap-2">
              <Sparkles className="text-yellow-400 fill-yellow-400" size={24} />
              Firework Farewell
            </h1>
            <p className="text-xs text-slate-400 tracking-widest uppercase">The Ritual of Radical Letting Go</p>
          </div>
          
          <div className="flex gap-4 bg-black/40 backdrop-blur-xl border border-white/10 p-3 rounded-2xl pointer-events-auto shadow-2xl">
            <div className="text-center px-2">
              <div className="text-[10px] text-slate-500 uppercase font-bold tracking-widest">Glow</div>
              <div className="text-lg font-black text-yellow-300 flex items-center gap-1 leading-none">
                <Zap size={14} className="fill-yellow-300" /> {score}
              </div>
            </div>
            <div className="w-px h-8 bg-white/10" />
            <div className="text-center px-2">
              <div className="text-[10px] text-slate-500 uppercase font-bold tracking-widest">Streak</div>
              <div className="text-lg font-black text-pink-400 leading-none">{streak}</div>
            </div>
            <div className="w-px h-8 bg-white/10" />
            <div className="text-center px-2">
              <div className="text-[10px] text-slate-500 uppercase font-bold tracking-widest">Best</div>
              <div className="text-lg font-black text-purple-400 flex items-center gap-1 leading-none">
                <Trophy size={14} /> {bestStreak}
              </div>
            </div>
          </div>
        </header>

        {/* Interaction Hub */}
        <div className="w-full max-w-xl bg-black/60 backdrop-blur-2xl border border-white/10 p-6 rounded-[2.5rem] shadow-[0_0_100px_rgba(0,0,0,0.8)] pointer-events-auto">
          <div className="space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="space-y-2">
                <label className="text-[10px] font-bold uppercase tracking-widest text-pink-400 flex items-center gap-1.5">
                  <Trash2 size={12} /> Letting go of...
                </label>
                <textarea
                  value={negative}
                  onChange={(e) => setNegative(e.target.value)}
                  placeholder="The old junk / pattern..."
                  className="w-full bg-white/5 border border-white/10 rounded-2xl p-4 text-sm focus:outline-none focus:border-pink-500/50 transition-all resize-none h-24"
                />
              </div>
              <div className="space-y-2">
                <label className="text-[10px] font-bold uppercase tracking-widest text-cyan-400 flex items-center gap-1.5">
                  <Send size={12} /> Calling in...
                </label>
                <textarea
                  value={positive}
                  onChange={(e) => setPositive(e.target.value)}
                  placeholder="The new intention / glow..."
                  className="w-full bg-white/5 border border-white/10 rounded-2xl p-4 text-sm focus:outline-none focus:border-cyan-500/50 transition-all resize-none h-24"
                />
              </div>
            </div>

            <button
              onClick={handleLaunch}
              className={`w-full py-4 rounded-2xl font-black uppercase tracking-[0.2em] text-sm transition-all flex items-center justify-center gap-3 group
                ${negative && positive 
                  ? 'bg-gradient-to-r from-pink-500 via-yellow-400 to-cyan-400 text-black shadow-[0_0_30px_rgba(236,72,153,0.4)] active:scale-95' 
                  : 'bg-white/5 text-slate-500 cursor-not-allowed'}`}
            >
              Launch Transformation
              <Sparkles size={18} className={negative && positive ? 'animate-pulse' : ''} />
            </button>
            
            <p className="text-center text-[10px] text-slate-500 uppercase tracking-widest">
              Burn the noise. Keep the light.
            </p>
          </div>
        </div>

        {/* Footer / Modes (Placeholder for Future) */}
        <footer className="w-full max-w-2xl flex justify-center gap-8 py-4 opacity-50">
          <button className="flex items-center gap-2 text-[10px] font-bold uppercase tracking-widest pointer-events-auto hover:opacity-100 transition-opacity">
            <History size={14} /> Journey Log
          </button>
          <div className="w-px h-4 bg-white/20" />
          <button className="flex items-center gap-2 text-[10px] font-bold uppercase tracking-widest pointer-events-auto hover:opacity-100 transition-opacity">
            <Zap size={14} size={14} /> Defender Mode (Coming)
          </button>
        </footer>
      </main>

      {/* Global Aesthetics */}
      <style>{`
        @keyframes drift {
          from { transform: translateY(0); }
          to { transform: translateY(-100px); }
        }
        body {
          background-color: #02020a;
          margin: 0;
          overflow: hidden;
          touch-action: manipulation;
        }
        textarea::placeholder {
          color: rgba(255,255,255,0.2);
        }
      `}</style>
    </div>
  );
};

export default App;

