import React, { useState, useEffect, useRef, useCallback } from 'react';
import * as THREE from 'three';
import {
  Sparkles,
  Trash2,
  Zap,
  Trophy,
  ArrowRight,
  RefreshCw,
  ZapOff,
  Star,
  ShieldAlert
} from 'lucide-react';

/**
 * FIREWORK FAREWELL - FREQUENCY FACTORY v1.1
 * OPTIMIZATIONS:
 * - Shared Geometries/Materials (Reduced Draw Calls/GC overhead)
 * - Touch Event Handling for Mobile Turret Control
 * - Strict Cleanup
 */

const PHASES = {
  PREP: 'PREP',
  TRANSITION: 'TRANSITION',
  DEFEND: 'DEFEND',
  ASCEND: 'ASCEND'
} as const;

type Phase = (typeof PHASES)[keyof typeof PHASES];

type ConstellationItem = {
  word: string;
  date: string;
};

const App: React.FC = () => {
  const [phase, setPhase] = useState<Phase>(PHASES.PREP);
  const [negative, setNegative] = useState('');
  const [positive, setPositive] = useState('');
  const [score, setScore] = useState<number>(() =>
    Number(localStorage.getItem('ff_score') || 0)
  );
  const [highScore, setHighScore] = useState<number>(() =>
    Number(localStorage.getItem('ff_highScore') || 0)
  );
  const [constellation, setConstellation] = useState<ConstellationItem[]>(() => {
    try {
      return JSON.parse(localStorage.getItem('ff_constellation') || '[]');
    } catch {
      return [];
    }
  });
  const [countdown, setCountdown] = useState(15);

  const canvasRef = useRef<HTMLCanvasElement | null>(null);
  
  // Engine State
  const engine = useRef<{
    scene: THREE.Scene | null;
    camera: THREE.PerspectiveCamera | null;
    renderer: THREE.WebGLRenderer | null;
    rockets: THREE.Mesh[];
    enemies: THREE.Mesh[];
    particles: (THREE.Mesh & {
      velocity?: THREE.Vector3;
      age?: number;
      maxAge?: number;
    })[];
    player: THREE.Group | null;
    stars: THREE.Points | null;
    clock: THREE.Clock;
    rafId?: number;
    resources: {
        enemyGeo?: THREE.BufferGeometry;
        enemyMat?: THREE.Material;
        rocketGeo?: THREE.BufferGeometry;
        rocketMat?: THREE.Material;
        particleGeo?: THREE.BufferGeometry;
    }
  }>({
    scene: null,
    camera: null,
    renderer: null,
    rockets: [],
    enemies: [],
    particles: [],
    player: null,
    stars: null,
    clock: new THREE.Clock(),
    resources: {}
  });

  // --- PERSISTENCE ---

  useEffect(() => {
    localStorage.setItem('ff_score', String(score));
    if (score > highScore) {
      setHighScore(score);
    }
  }, [score, highScore]);

  useEffect(() => {
    localStorage.setItem('ff_highScore', String(highScore));
  }, [highScore]);

  useEffect(() => {
    localStorage.setItem('ff_constellation', JSON.stringify(constellation));
  }, [constellation]);

  // --- THREE.JS ENGINE ---

  const initResources = () => {
    // Cache Geometries and Materials to prevent GC spikes
    engine.current.resources.enemyGeo = new THREE.DodecahedronGeometry(1, 0);
    engine.current.resources.enemyMat = new THREE.MeshStandardMaterial({
        color: 0xff0055,
        wireframe: true,
        emissive: 0xff0055,
        emissiveIntensity: 0.5
    });
    engine.current.resources.rocketGeo = new THREE.CylinderGeometry(0.1, 0.1, 1, 8);
    engine.current.resources.rocketMat = new THREE.MeshBasicMaterial({ color: 0x48f5ff });
    engine.current.resources.particleGeo = new THREE.SphereGeometry(0.08, 4, 4);
  };

  const triggerExplosion = (pos: THREE.Vector3, color: number) => {
    if (!engine.current.scene || !engine.current.resources.particleGeo) return;
    
    // We clone material here to allow different colors, but share geometry
    const mat = new THREE.MeshBasicMaterial({ color, transparent: true });

    for (let i = 0; i < 20; i++) { // Reduced particle count slightly for performance
      const p = new THREE.Mesh(
        engine.current.resources.particleGeo,
        mat
      ) as THREE.Mesh & {
        velocity?: THREE.Vector3;
        age?: number;
        maxAge?: number;
      };
      p.position.copy(pos);
      p.velocity = new THREE.Vector3(
        (Math.random() - 0.5) * 15,
        (Math.random() - 0.5) * 15,
        (Math.random() - 0.5) * 15
      );
      p.age = 0;
      p.maxAge = 0.8;
      engine.current.scene.add(p);
      engine.current.particles.push(p);
    }
  };

  useEffect(() => {
    if (!canvasRef.current) return;

    // 1. Setup Scene
    const scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x02020a, 0.04);

    const camera = new THREE.PerspectiveCamera(
      75,
      window.innerWidth / window.innerHeight,
      0.1,
      1000
    );
    camera.position.set(0, 5, 15);

    const renderer = new THREE.WebGLRenderer({
      canvas: canvasRef.current,
      antialias: true,
      alpha: true,
      powerPreference: 'high-performance'
    });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

    // 2. Initialize Resources
    initResources();

    // 3. Starfield
    const starGeo = new THREE.BufferGeometry();
    const starCount = 3000;
    const starPos = new Float32Array(starCount * 3);
    const starColors = new Float32Array(starCount * 3);
    for (let i = 0; i < starCount; i++) {
      starPos[i * 3] = (Math.random() - 0.5) * 150;
      starPos[i * 3 + 1] = (Math.random() - 0.5) * 150;
      starPos[i * 3 + 2] = (Math.random() - 0.5) * 150;
      const c = new THREE.Color().setHSL(Math.random(), 0.5, 0.8);
      starColors[i * 3] = c.r;
      starColors[i * 3 + 1] = c.g;
      starColors[i * 3 + 2] = c.b;
    }
    starGeo.setAttribute('position', new THREE.BufferAttribute(starPos, 3));
    starGeo.setAttribute('color', new THREE.BufferAttribute(starColors, 3));
    const starMat = new THREE.PointsMaterial({
      size: 0.1,
      vertexColors: true,
      transparent: true,
      opacity: 0.6
    });
    const stars = new THREE.Points(starGeo, starMat);
    scene.add(stars);

    // 4. Player (Defender Turret)
    const playerGroup = new THREE.Group();
    const core = new THREE.Mesh(
      new THREE.OctahedronGeometry(0.5, 0),
      new THREE.MeshStandardMaterial({
        color: 0x48f5ff,
        emissive: 0x48f5ff,
        emissiveIntensity: 2
      })
    );
    const ring = new THREE.Mesh(
      new THREE.TorusGeometry(0.8, 0.05, 8, 24),
      new THREE.MeshBasicMaterial({
        color: 0x48f5ff,
        transparent: true,
        opacity: 0.5
      })
    );
    ring.rotation.x = Math.PI / 2;
    playerGroup.add(core, ring);
    playerGroup.position.y = 1;
    scene.add(playerGroup);

    const light = new THREE.PointLight(0x48f5ff, 5, 20);
    light.position.set(0, 2, 0);
    playerGroup.add(light);

    engine.current.scene = scene;
    engine.current.camera = camera;
    engine.current.renderer = renderer;
    engine.current.player = playerGroup;
    engine.current.stars = stars;

    // 5. Animation Loop
    const animate = () => {
      const delta = engine.current.clock.getDelta();
      const { rockets, enemies, particles, scene, stars, player, renderer, camera } =
        engine.current;

      if (!scene || !renderer || !camera || !stars || !player) {
        engine.current.rafId = requestAnimationFrame(animate);
        return;
      }

      // Ambience
      stars.rotation.y += 0.0002;
      player.rotation.y += 0.05;

      // Rocket Physics
      engine.current.rockets = rockets.filter((r) => {
        r.position.z -= 45 * delta;

        // Collision Check
        for (const e of enemies) {
          if (r.position.distanceTo(e.position) < 2.0) { // Slightly generous hitbox
            triggerExplosion(e.position.clone(), 0xffeb5a);
            scene.remove(e);
            scene.remove(r);
            setScore((s) => s + 25);
            return false;
          }
        }

        if (r.position.z < -60) {
          scene.remove(r);
          return false;
        }
        return true;
      });

      // Enemy Physics
      engine.current.enemies = enemies.filter((e) => {
        e.position.z += 8 * delta;
        e.rotation.z += 2 * delta;
        if (e.position.z > 15) {
          scene.remove(e);
          setScore((s) => Math.max(0, s - 10)); // Penalty
          // Screen shake effect could go here
          return false;
        }
        return true;
      });

      // Particle Physics
      engine.current.particles = particles.filter((p) => {
        if (p.age == null || p.maxAge == null || !p.velocity) return false;
        p.age += delta;
        p.position.addScaledVector(p.velocity, delta);
        const mat = p.material as THREE.MeshBasicMaterial;
        if(mat) mat.opacity = 1 - p.age / p.maxAge;
        
        if (p.age >= p.maxAge) {
          scene.remove(p);
          if (p.geometry) p.geometry.dispose(); // Cleanup instantiated geometry if unique
          if (p.material instanceof THREE.Material) p.material.dispose();
          return false;
        }
        return true;
      });

      renderer.render(scene, camera);
      engine.current.rafId = requestAnimationFrame(animate);
    };

    engine.current.rafId = requestAnimationFrame(animate);

    const handleResize = () => {
      if (!engine.current.camera || !engine.current.renderer) return;
      engine.current.camera.aspect = window.innerWidth / window.innerHeight;
      engine.current.camera.updateProjectionMatrix();
      engine.current.renderer.setSize(window.innerWidth, window.innerHeight);
    };
    window.addEventListener('resize', handleResize);

    // Cleanup
    return () => {
      window.removeEventListener('resize', handleResize);
      if (engine.current.rafId) {
        cancelAnimationFrame(engine.current.rafId);
      }
      
      // Dispose Resources
      const { resources } = engine.current;
      resources.enemyGeo?.dispose();
      resources.enemyMat?.dispose();
      resources.rocketGeo?.dispose();
      resources.rocketMat?.dispose();
      resources.particleGeo?.dispose();

      renderer.dispose();
    };
  }, []);

  // --- INPUT HANDLING (MOUSE & TOUCH) ---

  const handleInputMove = useCallback((clientX: number) => {
    if (
        phase === PHASES.DEFEND &&
        engine.current.player &&
        engine.current.camera
      ) {
        const x = (clientX / window.innerWidth) * 2 - 1;
        // Smooth lerp could be added here, but direct mapping is snappier for arcade feel
        engine.current.player.position.x = x * 12;
        engine.current.camera.position.x = x * 3;
      }
  }, [phase]);

  const onMouseMove = (e: React.MouseEvent) => {
    handleInputMove(e.clientX);
  };

  const onTouchMove = (e: React.TouchEvent) => {
    if (e.touches.length > 0) {
        handleInputMove(e.touches[0].clientX);
    }
  };

  // --- GAME LOGIC ---

  const clearWorld = () => {
    const { scene, rockets, enemies, particles } = engine.current;
    if (!scene) return;
    rockets.forEach((r) => scene.remove(r));
    enemies.forEach((e) => scene.remove(e));
    particles.forEach((p) => {
        scene.remove(p);
        if(p.material instanceof THREE.Material) p.material.dispose();
    });
    engine.current.rockets = [];
    engine.current.enemies = [];
    engine.current.particles = [];
  };

  const spawnEnemy = () => {
    if (!engine.current.scene || !engine.current.resources.enemyGeo || !engine.current.resources.enemyMat) return;
    
    // Use cached geometry/material
    const enemy = new THREE.Mesh(
        engine.current.resources.enemyGeo,
        engine.current.resources.enemyMat
    );
    
    enemy.position.set((Math.random() - 0.5) * 20, Math.random() * 8, -50);
    engine.current.scene.add(enemy);
    engine.current.enemies.push(enemy);
  };

  const fire = () => {
    if (phase !== PHASES.DEFEND) return;
    if (!engine.current.scene || !engine.current.player || !engine.current.resources.rocketGeo || !engine.current.resources.rocketMat) return;
    
    // Use cached geometry/material
    const shot = new THREE.Mesh(
      engine.current.resources.rocketGeo,
      engine.current.resources.rocketMat
    );
    shot.position.copy(engine.current.player.position);
    shot.rotation.x = -Math.PI / 2;
    engine.current.scene.add(shot);
    engine.current.rockets.push(shot);
  };

  const endGame = () => {
    setConstellation((c) => [
      ...c,
      { word: positive, date: new Date().toLocaleDateString() }
    ]);
    setPhase(PHASES.ASCEND);
    if (engine.current.scene) {
      engine.current.enemies.forEach((e) => engine.current.scene!.remove(e));
    }
    engine.current.enemies = [];
  };

  const startSequence = () => {
    if (!negative || !positive) return;
    if (phase !== PHASES.PREP) return;

    setPhase(PHASES.TRANSITION);

    setTimeout(() => {
      // If user navigated away / reset, don't start
      if (phase !== PHASES.TRANSITION && phase !== PHASES.PREP) return;

      setPhase(PHASES.DEFEND);
      setCountdown(15);
      
      // Clear any existing entities just in case
      clearWorld();

      const gameTimer = setInterval(() => {
        setCountdown((c) => {
          if (c <= 1) {
            clearInterval(gameTimer);
            endGame();
            return 0;
          }
          spawnEnemy();
          return c - 1;
        });
      }, 1000);
    }, 2000);
  };

  const reset = () => {
    clearWorld();
    setNegative('');
    setPositive('');
    setCountdown(15);
    setPhase(PHASES.PREP);
  };

  // --- RENDER ---

  return (
    <div
      className="relative w-full h-screen bg-[#020208] text-white font-sans overflow-hidden select-none touch-none"
      onMouseMove={onMouseMove}
      onTouchMove={onTouchMove}
      onClick={fire}
    >
      <canvas ref={canvasRef} className="absolute inset-0 z-0" />

      {/* ACT I: THE GROUNDING */}
      {phase === PHASES.PREP && (
        <div className="relative z-10 flex flex-col items-center justify-center h-full p-6 animate-in fade-in zoom-in duration-1000">
          <div className="max-w-md w-full space-y-12 text-center">
            <header className="space-y-2">
              <h1 className="text-5xl font-black italic tracking-tighter bg-gradient-to-br from-white to-slate-500 bg-clip-text text-transparent uppercase">
                Firework Farewell
              </h1>
              <p className="text-[10px] tracking-[0.6em] text-cyan-400 font-bold uppercase">
                Frequency Factory // Big Chakra
              </p>
            </header>

            <div className="space-y-8 bg-white/5 backdrop-blur-xl border border-white/10 p-8 rounded-[3rem] shadow-2xl">
              <div className="space-y-4">
                <label className="text-[10px] font-black uppercase tracking-widest text-pink-500 flex items-center justify-center gap-2">
                  <Trash2 size={12} /> Vaporize the Junk
                </label>
                <input
                  value={negative}
                  onChange={(e) => setNegative(e.target.value)}
                  placeholder="The old pattern..."
                  className="w-full bg-transparent border-b border-white/10 p-2 text-center text-xl font-light focus:outline-none focus:border-pink-500 transition-all placeholder:text-white/10"
                />
              </div>

              <div className="space-y-4">
                <label className="text-[10px] font-black uppercase tracking-widest text-cyan-400 flex items-center justify-center gap-2">
                  <Sparkles size={12} /> Materialize the Glow
                </label>
                <input
                  value={positive}
                  onChange={(e) => setPositive(e.target.value)}
                  placeholder="The new intention..."
                  className="w-full bg-transparent border-b border-white/10 p-2 text-center text-xl font-light focus:outline-none focus:border-cyan-400 transition-all placeholder:text-white/10"
                />
              </div>

              <button
                onClick={startSequence}
                className={`w-full py-5 rounded-2xl font-black uppercase tracking-[0.2em] text-xs transition-all flex items-center justify-center gap-3
                  ${
                    negative && positive
                      ? 'bg-white text-black hover:bg-cyan-400 shadow-[0_0_30px_rgba(255,255,255,0.2)]'
                      : 'bg-white/5 text-white/20 cursor-not-allowed'
                  }`}
              >
                Commence Ritual <ArrowRight size={16} />
              </button>
            </div>
          </div>
        </div>
      )}

      {/* TRANSITION: HYPERSPACE */}
      {phase === PHASES.TRANSITION && (
        <div className="relative z-10 flex flex-col items-center justify-center h-full animate-pulse">
          <div className="text-[10px] font-black tracking-[1em] text-cyan-400 uppercase">
            Aligning Neural Pathways...
          </div>
        </div>
      )}

      {/* ACT II: THE PURGE */}
      {phase === PHASES.DEFEND && (
        <div className="relative z-10 h-full flex flex-col justify-between p-10 pointer-events-none">
          <div className="flex justify-between items-start">
            <div className="space-y-1">
              <div className="text-[10px] font-black uppercase tracking-widest text-pink-500 flex items-center gap-2">
                <ZapOff size={14} /> Eliminating
              </div>
              <div className="text-3xl font-black italic uppercase text-pink-500 blur-[0.5px]">
                {negative}
              </div>
            </div>
            <div className="text-right space-y-1">
              <div className="text-[10px] font-black uppercase tracking-widest text-cyan-400 flex items-center justify-end gap-2">
                Weaponizing{' '}
                <Zap size={14} className="fill-cyan-400 text-cyan-400" />
              </div>
              <div className="text-3xl font-black italic uppercase text-white drop-shadow-[0_0_10px_rgba(255,255,255,0.8)]">
                {positive}
              </div>
            </div>
          </div>

          <div className="text-center space-y-2">
            <div className="text-8xl font-black tracking-tighter opacity-10 italic">
              {countdown}
            </div>
            <div className="text-4xl font-black text-cyan-400 tabular-nums drop-shadow-[0_0_20px_rgba(34,211,238,0.5)]">
              {score.toLocaleString()}
            </div>
          </div>

          <div className="flex justify-center">
            <div className="px-6 py-2 rounded-full border border-white/10 bg-black/50 backdrop-blur-md text-[10px] font-bold tracking-[0.3em] uppercase flex items-center gap-2">
              <ShieldAlert size={14} className="text-red-500 animate-pulse"/> Defend your Intention
            </div>
          </div>
        </div>
      )}

      {/* ACT III: THE ASCENSION */}
      {phase === PHASES.ASCEND && (
        <div className="relative z-10 h-full flex flex-col items-center justify-center p-8 bg-black/90 backdrop-blur-3xl animate-in fade-in duration-1000">
          <div className="max-w-2xl w-full space-y-12">
            <div className="text-center space-y-4">
              <div className="inline-block p-4 rounded-full bg-cyan-500/10 border border-cyan-500/20 text-cyan-400 mb-4">
                <Trophy size={48} className="animate-bounce" />
              </div>
              <h2 className="text-6xl font-black italic uppercase tracking-tighter leading-none">
                Ascension Complete
              </h2>
              <p className="text-slate-500 text-sm tracking-widest uppercase">
                The frequency has been tuned. {positive} is now part of your sky.
              </p>
            </div>

            <div className="space-y-4">
              <div className="flex items-center gap-4 text-[10px] font-black uppercase tracking-widest text-slate-500">
                <div className="h-px flex-1 bg-white/10" />
                Your Permanent Constellation
                <div className="h-px flex-1 bg-white/10" />
              </div>
              <div className="flex flex-wrap justify-center gap-3">
                {constellation.slice(-12).map((item, i) => (
                  <div
                    key={`${item.word}-${item.date}-${i}`}
                    className="px-5 py-3 rounded-2xl bg-white/5 border border-white/10 hover:border-yellow-400/50 transition-all group cursor-default"
                  >
                    <div className="flex items-center gap-2 text-xs font-black uppercase italic group-hover:text-yellow-200">
                      <Star
                        size={12}
                        className="fill-yellow-400 text-yellow-400"
                      />{' '}
                      {item.word}
                    </div>
                  </div>
                ))}
              </div>
            </div>

            <div className="flex gap-4">
              <button
                onClick={reset}
                className="flex-1 py-6 rounded-3xl bg-white text-black font-black uppercase tracking-widest text-xs flex items-center justify-center gap-3 hover:bg-cyan-400 transition-all"
              >
                <RefreshCw size={16} /> New Ritual
              </button>
            </div>
          </div>
        </div>
      )}

      {/* LOGO STAMP */}
      <div className="absolute bottom-6 right-6 z-20 opacity-20 hover:opacity-100 transition-opacity">
        <div className="text-[10px] font-black tracking-widest text-white uppercase text-right">
          Frequency Factory
          <br />
          Archive _001
        </div>
      </div>
    </div>
  );
};

export default App;

