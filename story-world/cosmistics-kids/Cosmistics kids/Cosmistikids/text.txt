<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quency's Frequency Fitter â€” Enhanced</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js for accurate musical timing and sound generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --quency-blue: #00BFFF; /* Deep Holographic Blue */
            --quency-pink: #FF69B4; /* Neon Pink */
            --background-dark: #100C2A; /* Space Black/Purple */
            --text-silver: #D1D5DB;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-dark);
            color: var(--text-silver);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            overflow-x: hidden;
        }
        .game-container {
            width: 100%;
            max-width: 600px;
            background-color: #1a1538;
            border: 2px solid var(--quency-blue);
            box-shadow: 0 0 40px rgba(0, 191, 255, 0.4);
            border-radius: 20px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            position: relative;
            z-index: 10;
        }
        canvas {
            border-radius: 10px;
            background-color: #2c2554;
            border: 1px solid var(--quency-pink);
            box-shadow: inset 0 0 10px rgba(255, 105, 180, 0.3);
            position: relative;
            overflow: hidden;
            width: 100%; /* Ensure canvas is fully responsive */
        }
        /* Holographic grid background for canvas */
        #frequencyCanvas {
             background-image: 
                linear-gradient(to right, rgba(255,255,255,0.05) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .hologram-glow {
            text-shadow: 0 0 8px var(--quency-pink), 0 0 12px var(--quency-blue);
        }
        /* Frequency Bar (re-added) */
        .frequency-bar-bg {
            height: 15px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 9999px;
            overflow: hidden;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
        }
        .frequency-bar-fill {
            height: 100%;
            transition: width 0.1s ease-out;
            background: linear-gradient(90deg, var(--quency-pink), var(--quency-blue));
        }

        .control-button {
            padding: 0.75rem 1.5rem;
            font-weight: 700;
            border-radius: 12px;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(0, 191, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .control-button:active {
            transform: scale(0.95);
            box-shadow: none;
        }
        .btn-plus {
            background-color: var(--quency-blue);
            color: white;
            border: 2px solid var(--quency-blue);
        }
        .btn-minus {
            background-color: var(--quency-pink);
            color: white;
            border: 2px solid var(--quency-pink);
        }

        .feedback-message {
            min-height: 4rem;
            padding: 1rem;
            border: 1px dashed var(--text-silver);
            border-radius: 10px;
            background-color: rgba(255, 255, 255, 0.05);
            font-style: italic;
        }
        
        /* Character styling */
        .character-img {
            image-rendering: pixelated; 
            transition: transform 0.1s ease-out;
        }
        .quency-blink {
            animation: blink 3s infinite steps(1);
        }
        @keyframes blink {
            0%, 10% { transform: scaleY(1); }
            11%, 13% { transform: scaleY(0.1); }
            14%, 100% { transform: scaleY(1); }
        }
        .cosmo-reaction {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform-origin: bottom center;
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.5)); 
        }
        .cosmo-happy {
            transform: translateY(-5px) scale(1.05);
            opacity: 1;
        }
        .cosmo-neutral {
            transform: translateY(0) scale(1);
            opacity: 0.8;
        }
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
            border-bottom: 1px dotted rgba(255, 255, 255, 0.1);
        }
        .leaderboard-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
<div class="game-container">
    
    <!-- HEADER: Quency Avatar and Title -->
    <div class="flex justify-between items-center mb-4">
        <!-- Quency Avatar (Pixel Art - Base64 of a pixel cat) -->
        <img id="quencyAvatar" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABAAQMAAACQCAjNAAAABlBMVEX///8AAABVwtN+AAAAAXRSTlMAQObYZgAAAFNJREFUeF7tzssNwCAUA1A2eYfuuAEN22D+A4n0z2L83DIIoZ7oD4y2vK9v/x8J2D9fI/H0VwJ3/u7m4F4Q+iT8r2fP7l4J3D/x/AABW2xAR+G1rVAAAAABJRU5ErkJggg==" 
             alt="Quency AI" class="character-img w-12 h-12 quency-blink border-2 border-blue-500 rounded-full p-0.5">
        <h1 class="title text-3xl font-extrabold text-center hologram-glow flex-grow">
            FREQUENCY FITTER
        </h1>
        <!-- Placeholder for alignment -->
        <div class="w-12 h-12"></div> 
    </div>

    <p class="text-sm text-center text-gray-400 -mt-2 mb-2">
        Time limit: **30 seconds** to reach the highest frequency score!
    </p>

    <!-- CANVAS and COSMO IMAGE -->
    <div class="relative w-full">
        <canvas id="frequencyCanvas" width="560" height="200"></canvas>
        
        <!-- Cosmo Reaction (Base64 of a surprised/neutral Cosmo, similar to Image 3) -->
        <img id="cosmoReaction" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABAAQMAAACQCAjNAAAABlBMVEX///8AAABVwtN+AAAAAXRSTlMAQObYZgAAALBJREFUeF5jYBgF9ADcM5c/wJgBBgZGdgacM/f/DAwsM/f/DAwsM/f/DEx1g8A6gA0A6wDqAOoA6gDqAOoA6gDqAOoA6gDqAOoA6gBwBkA7gGkABj4kAGgH0A7w0ADwHmAADcM0AFQANANoBtANoBtANoBtANoBtANoBtANoBtANoBtANoBtANoBtANoBtANoBtANoBtANoBtANoBtANoBtANoBtANoBtANoBtANoBtANoBtANoBtANoBtANoBtANoBtANoBtANoBtANoBtANoBvDAA6wAWA7gDwH2ADwHWAQwGkAZiAgIAKzMDMwMDExBgAAcDGwMDABMDMwMAA0M3AwoAGwMDAAODmYAOAABgYmDABMDMwMDBABwA+gE0AjUf/DAwMDADcMwsDAwBwB0B1w3B1Q3T9g/Y/u/w+AAMDUwMDATcDDQADAxMDCwAwBwBQAXAAgA2gGoD9j/wAAACf0n9bAAAAAElFTkSuQmCC" 
             alt="Cosmo Reaction" class="cosmo-reaction absolute bottom-0 right-0 w-16 h-16 md:w-20 md:h-20 cosmo-neutral">
    </div>

    <!-- SCORE & BAR -->
    <div class="flex justify-between items-center text-sm font-semibold mt-2">
        <span>Your Vibe: <span id="vibeLevel" class="text-lg text-blue-300">50%</span></span>
        <span>Frequency Match: <span id="matchScore" class="text-lg text-pink-300">0%</span></span>
    </div>
    <div class="frequency-bar-bg">
        <div id="frequencyBar" class="frequency-bar-fill" style="width: 50%;"></div>
    </div>
    
    <!-- CONTROLS -->
    <div class="flex justify-around gap-4 mt-2">
        <button id="minusButton" class="control-button btn-minus flex-1">
            <span class="text-2xl font-light">VIBE DOWN</span>
        </button>
        <button id="plusButton" class="control-button btn-plus flex-1">
            <span class="text-2xl font-light">VIBE UP</span>
        </button>
    </div>
    
    <!-- GAME STATS -->
    <div class="flex justify-between items-center text-sm mt-3">
        <span>**Score:** <span id="score" class="text-pink-300 font-bold">0</span></span>
        <span>**Combo:** <span id="combo" class="text-blue-300 font-bold">0</span>x</span>
    </div>

    <!-- SETTINGS & MUTE -->
    <div class="mt-3 flex justify-between items-center text-sm p-2 bg-gray-900 rounded-lg">
        <label>Difficulty (Tolerance):
            <select id="difficulty" class="bg-gray-800 border border-blue-400 rounded px-2 py-1 text-sm ml-2">
                <option value="10">Easy (Tolerant)</option>
                <option value="6" selected>Normal (Standard)</option>
                <option value="3">Hard (Precise)</option>
            </select>
        </label>
        <button id="muteToggle" class="bg-gray-700 px-3 py-1 rounded text-xs font-semibold hover:bg-gray-600">Mute: Off</button>
    </div>

    <!-- QUENCY FEEDBACK BOX -->
    <div id="feedback" class="feedback-message">
        <p class="text-blue-300 font-extrabold">QUENCY:</p>
        <p id="feedbackText" class="text-gray-300">System initialization complete. Ready to tune frequencies.</p>
    </div>
    
    <!-- START BUTTON -->
    <button id="startButton" class="w-full mt-4 bg-green-500 hover:bg-green-600 py-3 rounded-xl font-extrabold text-white transition-colors">
        START FREQUENCY TEST (30s)
    </button>
    
    <!-- LEADERBOARD -->
    <div class="mt-4 text-center">
        <h2 class="font-extrabold text-xl mb-1 text-pink-300 hologram-glow">FREQUENCY TOP SCORES</h2>
        <ul id="leaderboard" class="text-sm text-gray-300 w-full"></ul>
    </div>
</div>

<script>
    const c = document.getElementById("frequencyCanvas"), ctx = c.getContext("2d");
    const vibeEl = document.getElementById("vibeLevel"), matchEl = document.getElementById("matchScore");
    const scoreEl = document.getElementById("score"), comboEl = document.getElementById("combo");
    const feedbackText = document.getElementById("feedbackText"), muteBtn = document.getElementById("muteToggle");
    const leaderboardEl = document.getElementById("leaderboard"), diffSel = document.getElementById("difficulty");
    const startButton = document.getElementById("startButton");
    const vibeBar = document.getElementById("frequencyBar");
    const cosmoReaction = document.getElementById('cosmoReaction');
    
    let vibe = 50;
    let target = 0;
    let score = 0;
    let combo = 0;
    let playing = false;
    let gameInterval;
    const GAME_DURATION = 30000; // 30 seconds
    
    // Retrieve and sort leaderboard data
    let best = JSON.parse(localStorage.getItem("leaderboard") || "[]").map(s => parseInt(s)).sort((a, b) => b - a);

    // --- Tone.js Music Setup ---
    const synth = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: "sine" },
        envelope: { attack: 0.01, decay: 0.2, sustain: 0.05, release: 0.5 }
    }).toDestination();
    
    const feedbackSynth = new Tone.Synth({
        oscillator: { type: "square" },
        envelope: { attack: 0.005, decay: 0.1, sustain: 0.05, release: 0.1 }
    }).toDestination();

    // Map vibe level to a frequency for the synth (C3 to C5 range)
    function note(v) {
        const midi = Math.floor(Tone.Midi(48).toMidi() + (v / 100) * 24);
        return Tone.Midi(midi).toNote();
    }
    
    // Helper to convert CSS variable to rgba string
    function varToRgb(varName, alpha = 1) {
        const color = getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
        if (color.startsWith('#')) {
            const r = parseInt(color.slice(1, 3), 16);
            const g = parseInt(color.slice(3, 5), 16);
            const b = parseInt(color.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }
        return color; // fallback
    }

    // --- Leaderboard Functions ---
    function updateLeaderboard() {
        leaderboardEl.innerHTML = best.slice(0, 5).map((s, i) => 
            `<li class="leaderboard-item"><span>${i + 1}. Score:</span><span class="font-bold text-pink-300">${s}</span></li>`
        ).join("");
    }

    function saveScore() {
        best.push(score);
        best.sort((a, b) => b - a);
        best = best.slice(0, 5);
        localStorage.setItem("leaderboard", JSON.stringify(best));
        updateLeaderboard();
    }

    // --- Canvas Drawing Functions ---
    function drawFrequencies() {
        const W = c.width, H = c.height;
        ctx.clearRect(0, 0, W, H);

        // 1. Draw Target Wave (Pink/Input Frequency)
        ctx.strokeStyle = varToRgb('--quency-pink', 0.6);
        ctx.lineWidth = 3;
        ctx.beginPath();
        drawWave(target, H * 0.35, 30);
        ctx.stroke();
        
        // 2. Draw Player Wave (Blue/Adjusted Frequency)
        ctx.strokeStyle = varToRgb('--quency-blue', 0.8);
        ctx.lineWidth = 4;
        ctx.beginPath();
        drawWave(vibe, H * 0.65, 40);
        ctx.stroke();
    }

    function drawWave(frequencyValue, centerY, amplitude) {
        const W = c.width;
        // Adjust period based on frequency value for visual difference
        const period = 50 + (100 - frequencyValue) * 0.5; 
        ctx.moveTo(0, centerY);
        for (let x = 0; x < W; x++) {
            // Sine wave formula: y = A * sin(kx + wt) + C
            const y = centerY + amplitude * Math.sin(x / period + Date.now() / 300);
            ctx.lineTo(x, y);
        }
    }

    // --- Game Logic ---
    function updateGame() {
        if (!playing) return;
        
        const diff = Math.abs(vibe - target);
        const tolerance = parseFloat(diffSel.value);
        const match = Math.max(0, 100 - diff * 2); // 50+ diff = 0 match
        const near = diff < tolerance;
        
        vibeEl.textContent = vibe + "%";
        vibeBar.style.width = vibe + "%";
        matchEl.textContent = Math.round(match) + "%";
        
        // Score and Combo Update
        if (near) {
            combo++;
            score += 1 + Math.floor(combo / 5);
            feedbackText.textContent = `QUENCY: Optimal Vibe! Combo x${combo}.`;
            cosmoReaction.classList.add('cosmo-happy');
            cosmoReaction.classList.remove('cosmo-neutral');
            feedbackSynth.triggerAttackRelease("A5", "32n");
        } else {
            combo = 0;
            feedbackText.textContent = "QUENCY: Signal drift detected. Recalibrating...";
            cosmoReaction.classList.remove('cosmo-happy');
            cosmoReaction.classList.add('cosmo-neutral');
        }

        scoreEl.textContent = score;
        comboEl.textContent = combo;

        // Target shifts randomly if match is good (harder difficulty)
        if (match > 90 && Math.random() < 0.05) { 
            const range = 15;
            const min = Math.max(0, target - range);
            const max = Math.min(100, target + range);
            target = Math.floor(Math.random() * (max - min + 1)) + min;
        }

        drawFrequencies();
    }

    function gameLoop(t) {
        if (!playing) return;
        updateGame();
        requestAnimationFrame(gameLoop);
    }

    let musicLoop;
    function startGame() {
        if (playing) return;
        playing = true;
        score = 0;
        combo = 0;
        vibe = 50;
        target = Math.random() * 100;

        startButton.classList.add('hidden');
        feedbackText.textContent = "QUENCY: Go Nova! You have 30 seconds to sync the Funhouse.";
        
        // Start Tone.js Transport and Looping Music
        Tone.start();
        Tone.Transport.stop();
        Tone.Transport.cancel();
        
        if (musicLoop) musicLoop.dispose();
        musicLoop = new Tone.Loop(time => {
            // Play notes corresponding to Vibe and Target
            synth.triggerAttackRelease([note(vibe), note(target)], "4n", time);
        }, "4n").start(0);
        Tone.Transport.start();

        // Start the visual and logic loop
        requestAnimationFrame(gameLoop);

        // Set the timer for game end
        setTimeout(endGame, GAME_DURATION);
    }

    function endGame() {
        playing = false;
        Tone.Transport.stop();
        saveScore();
        feedbackText.textContent = `QUENCY: Session complete. Your final score is ${score}. Uploading to Leaderboard...`;
        startButton.textContent = "PLAY AGAIN!";
        startButton.classList.remove('hidden');
    }
    
    // --- Event Handlers ---
    document.getElementById("startButton").onclick = startGame;
    
    document.getElementById("plusButton").onclick = () => {
        if (playing) {
            vibe = Math.min(100, vibe + 2);
            feedbackSynth.triggerAttackRelease("G4", "32n");
        }
    };
    document.getElementById("minusButton").onclick = () => {
        if (playing) {
            vibe = Math.max(0, vibe - 2);
            feedbackSynth.triggerAttackRelease("G3", "32n");
        }
    };
    
    document.addEventListener("keydown", e => {
        if (!playing) return;
        if (e.key === "ArrowUp" || e.key.toLowerCase() === "w") {
            e.preventDefault();
            vibe = Math.min(100, vibe + 2);
        }
        if (e.key === "ArrowDown" || e.key.toLowerCase() === "s") {
            e.preventDefault();
            vibe = Math.max(0, vibe - 2);
        }
    });

    muteBtn.onclick = () => {
        Tone.Destination.mute = !Tone.Destination.mute;
        muteBtn.textContent = "Mute: " + (Tone.Destination.mute ? "On" : "Off");
    };

    // Initialize on load
    window.onload = function() {
        updateLeaderboard();
        drawFrequencies();
    }
</script>
</body>
</html>

