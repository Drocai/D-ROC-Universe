<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Smash china, rack up combos, and stream Dumb Bull in a China Shop by D RoC!">
    <meta property="og:title" content="Dumb Bull in a China Shop - Game">
    <meta property="og:description" content="I just scored [SCORE] points! Can you beat me?">
    <meta property="og:image" content="https://yourdomain.com/share-card.png">
    <title>Dumb Bull in a China Shop | D RoC</title>

```
<!-- Analytics: Plausible.io - Replace with your domain -->
<script defer data-domain="yourgame.netlify.app" src="https://plausible.io/js/script.js"></script>

<!-- Rewarded Ads: Applixir SDK - Get your APP_ID from applixir.com -->
<script src="https://cdn.applixir.com/applixir.sdk3.0m.js"></script>

<style>
    * { box-sizing: border-box; }
    body, html {
        margin: 0; padding: 0;
        width: 100%; height: 100%;
        overflow: hidden;
        background: #0a0a0a;
        font-family: 'Arial Black', sans-serif;
        touch-action: none;
        user-select: none;
        -webkit-user-select: none;
        -webkit-tap-highlight-color: transparent;
    }

    #gameCanvas {
        display: block;
        width: 100%; height: 100%;
        image-rendering: pixelated;
        image-rendering: crisp-edges;
    }

    /* --- HUD --- */
    #ui {
        position: absolute; top: 15px; left: 15px;
        font-family: 'Courier New', monospace;
        color: #00f0ff;
        pointer-events: none;
        z-index: 5;
        text-shadow: 0 0 8px #00f0ff, 0 2px 0 rgba(0,0,0,0.8);
    }
    .hud-label { font-size: 11px; opacity: 0.8; letter-spacing: 1px; }
    .hud-val { font-size: 28px; font-weight: 900; margin-top: 2px; }

    #waveInfo {
        position: absolute; top: 15px; right: 15px;
        text-align: right; color: #ff0055;
        font-size: 14px; font-family: 'Courier New', monospace;
        text-shadow: 0 0 8px #ff0055, 0 2px 0 rgba(0,0,0,0.8);
        pointer-events: none; z-index: 5;
    }
    #waveNum { font-size: 36px; font-weight: 900; }

    #hornsDisplay {
        position: absolute; top: 80px; left: 15px;
        color: #f1c40f;
        font-size: 20px; font-family: 'Courier New', monospace;
        text-shadow: 0 0 8px #f1c40f, 0 2px 0 rgba(0,0,0,0.8);
        pointer-events: none; z-index: 5;
    }

    #comboTxt {
        position: absolute; top: 35%; left: 50%;
        transform: translate(-50%, -50%);
        font-size: 52px; 
        font-weight: 900;
        background: linear-gradient(45deg, #f1c40f, #e67e22);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        filter: drop-shadow(0px 4px 0px rgba(0,0,0,0.7));
        opacity: 0;
        transition: transform 0.2s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        pointer-events: none; z-index: 6;
        white-space: nowrap;
    }

    #lyricFlash {
        position: absolute; bottom: 30%; left: 50%;
        transform: translateX(-50%);
        font-size: 28px; color: white;
        text-shadow: 0 0 20px #ff0055, 0 4px 0 rgba(0,0,0,0.9);
        opacity: 0; transition: opacity 0.3s;
        pointer-events: none; z-index: 6;
        font-style: italic;
    }

    /* --- CONTROLS --- */
    #joystickOuter {
        position: absolute; bottom: 30px; left: 30px;
        width: 130px; height: 130px;
        background: rgba(0, 240, 255, 0.08);
        border: 3px solid rgba(0, 240, 255, 0.4);
        border-radius: 50%;
        box-shadow: 0 0 20px rgba(0, 240, 255, 0.2);
        z-index: 10;
    }

    #joystickInner {
        position: absolute; left: 50%; top: 50%;
        width: 55px; height: 55px;
        background: linear-gradient(135deg, rgba(0, 240, 255, 0.9), rgba(0, 180, 255, 0.7));
        border: 2px solid rgba(0, 240, 255, 1);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        box-shadow: 0 0 15px rgba(0, 240, 255, 0.6);
        pointer-events: none;
    }

    #dashBtn {
        position: absolute; bottom: 40px; right: 30px;
        width: 95px; height: 95px;
        background: linear-gradient(135deg, rgba(255, 0, 85, 0.9), rgba(200, 0, 60, 0.8));
        border: 3px solid #ff0055;
        border-radius: 50%;
        color: white; font-weight: 900; font-size: 16px;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 0 25px rgba(255, 0, 85, 0.5);
        text-shadow: 0 2px 0 rgba(0,0,0,0.6);
        transition: transform 0.1s, filter 0.1s;
        z-index: 10;
    }
    #dashBtn:active { transform: scale(0.92); }
    #dashBtn.cooldown {
        filter: grayscale(1) brightness(0.6);
        opacity: 0.6;
    }

    /* --- OVERLAYS --- */
    .overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(10, 10, 10, 0.96);
        backdrop-filter: blur(8px);
        display: flex; flex-direction: column;
        align-items: center; justify-content: center;
        z-index: 50; text-align: center; color: white;
    }
    .overlay h1 {
        font-size: 3.5rem; 
        letter-spacing: -1px;
        margin: 0 20px 10px;
        background: linear-gradient(45deg, #00f0ff, #ff0055);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: none;
        line-height: 1.1;
    }
    .overlay h2 {
        font-size: 2rem;
        color: #f1c40f;
        margin: 10px 0;
        text-shadow: 0 0 10px #f1c40f;
    }
    .overlay p {
        color: #bdc3c7;
        font-family: 'Courier New', monospace;
        margin: 15px 20px;
        font-size: 14px;
        max-width: 600px;
    }
    .btn {
        margin: 12px;
        padding: 18px 50px;
        font-size: 1.1rem;
        background: transparent;
        color: #00f0ff;
        border: 3px solid #00f0ff;
        text-transform: uppercase;
        letter-spacing: 3px;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 0 20px rgba(0, 240, 255, 0.3);
        font-family: 'Arial Black', sans-serif;
        font-weight: 900;
    }
    .btn:hover {
        background: #00f0ff;
        color: #000;
        box-shadow: 0 0 40px rgba(0, 240, 255, 0.8);
        transform: scale(1.05);
    }
    .btn.secondary {
        color: #ff0055;
        border-color: #ff0055;
        box-shadow: 0 0 20px rgba(255, 0, 85, 0.3);
    }
    .btn.secondary:hover {
        background: #ff0055;
        color: #fff;
        box-shadow: 0 0 40px rgba(255, 0, 85, 0.8);
    }
    .btn.primary {
        background: linear-gradient(135deg, #00f0ff, #0080ff);
        color: #000;
        border: none;
        box-shadow: 0 0 30px rgba(0, 240, 255, 0.6);
        font-size: 1.3rem;
        padding: 20px 60px;
    }
    .btn.primary:hover {
        box-shadow: 0 0 50px rgba(0, 240, 255, 1);
        transform: scale(1.08);
    }

    #waveTransition {
        display: none;
        background: rgba(0, 0, 0, 0.98);
        animation: fadeInOut 2s ease;
    }
    @keyframes fadeInOut {
        0%, 100% { opacity: 0; }
        50% { opacity: 1; }
    }

    /* Shop */
    .upgrade-grid {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        justify-content: center;
        margin: 20px 0;
    }
    .upgrade-card {
        background: rgba(0, 240, 255, 0.05);
        border: 2px solid rgba(0, 240, 255, 0.3);
        padding: 20px;
        border-radius: 10px;
        width: 200px;
        transition: all 0.3s;
    }
    .upgrade-card:hover {
        border-color: #00f0ff;
        box-shadow: 0 0 30px rgba(0, 240, 255, 0.4);
        transform: translateY(-5px);
    }
    .upgrade-card h3 {
        color: #00f0ff;
        font-size: 18px;
        margin: 0 0 10px;
    }
    .upgrade-card p {
        font-size: 12px;
        margin: 10px 0;
    }
    .upgrade-card .price {
        color: #f1c40f;
        font-size: 20px;
        font-weight: 900;
    }
    .upgrade-card.owned {
        opacity: 0.5;
        border-color: #27ae60;
    }
    .upgrade-card.owned::after {
        content: "‚úì OWNED";
        display: block;
        color: #27ae60;
        font-size: 14px;
        margin-top: 10px;
    }

    /* Email Input */
    input[type="email"] {
        padding: 15px 20px;
        font-size: 16px;
        border: 2px solid #00f0ff;
        background: rgba(0, 240, 255, 0.05);
        color: white;
        border-radius: 5px;
        margin: 10px;
        width: 300px;
        max-width: 90%;
        font-family: 'Courier New', monospace;
    }
    input[type="email"]:focus {
        outline: none;
        box-shadow: 0 0 20px rgba(0, 240, 255, 0.5);
    }

    .checkbox-container {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 10px;
        font-size: 12px;
    }
    .checkbox-container input {
        margin-right: 8px;
    }

    #leaderboard {
        margin: 20px auto;
        width: 90%;
        max-width: 500px;
        text-align: left;
    }
    .lb-entry {
        background: rgba(0, 240, 255, 0.05);
        padding: 10px 15px;
        margin: 5px 0;
        border-left: 3px solid #00f0ff;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        display: flex;
        justify-content: space-between;
    }
    .lb-entry.you {
        background: rgba(255, 0, 85, 0.1);
        border-left-color: #ff0055;
    }

    .stream-cta {
        display: inline-block;
        margin: 20px 10px;
        padding: 15px 40px;
        background: linear-gradient(135deg, #1DB954, #1ed760);
        color: white;
        text-decoration: none;
        border-radius: 50px;
        font-size: 18px;
        font-weight: 900;
        box-shadow: 0 0 30px rgba(29, 185, 84, 0.6);
        transition: all 0.3s;
    }
    .stream-cta:hover {
        transform: scale(1.1);
        box-shadow: 0 0 50px rgba(29, 185, 84, 1);
    }
    .stream-cta.apple {
        background: linear-gradient(135deg, #FA243C, #ff4d5e);
        box-shadow: 0 0 30px rgba(250, 36, 60, 0.6);
    }

    @media (max-width: 600px) {
        .overlay h1 { font-size: 2.5rem; }
        .upgrade-grid { flex-direction: column; align-items: center; }
        .stream-cta { font-size: 16px; padding: 12px 30px; }
    }
</style>
```

</head>
<body>

```
<canvas id="gameCanvas"></canvas>

<!-- HUD -->
<div id="ui">
    <div class="hud-label">SCORE</div>
    <div class="hud-val" id="scoreVal">0</div>
    <div class="hud-label" style="margin-top:10px;">STREAK</div>
    <div class="hud-val" id="streakVal" style="color:#ff0055">0</div>
</div>

<div id="waveInfo">
    <div style="font-size:12px;">WAVE</div>
    <div id="waveNum">1</div>
    <div id="waveTimer" style="font-size:14px; margin-top:5px;">45s</div>
</div>

<div id="hornsDisplay">üêÇ <span id="hornsCount">0</span> HORNS</div>

<div id="comboTxt"></div>
<div id="lyricFlash"></div>

<!-- Controls -->
<div id="joystickOuter"><div id="joystickInner"></div></div>
<div id="dashBtn">DASH</div>

<!-- START OVERLAY -->
<div id="startOverlay" class="overlay">
    <h1>DUMB BULL<br>IN A CHINA SHOP</h1>
    <p style="color:#00f0ff; font-size:16px; margin-bottom:5px;">by D RoC</p>
    <p>
        <span style="color:#00f0ff">[JOYSTICK]</span> MOVE &nbsp;‚Ä¢&nbsp; 
        <span style="color:#ff0055">[DASH]</span> SMASH
    </p>
    <p style="font-size:12px; opacity:0.7;">Destroy china, rack up combos, survive 5 waves!</p>
    <button class="btn primary" id="startBtn">üêÇ SMASH NOW</button>
</div>

<!-- WAVE TRANSITION -->
<div id="waveTransition" class="overlay">
    <h2 id="waveTransText"></h2>
    <p id="waveTransSubtext"></p>
</div>

<!-- SHOP OVERLAY -->
<div id="shopOverlay" class="overlay" style="display:none;">
    <h2>‚ö° UPGRADE SHOP</h2>
    <p>Spend your HORNS to power up!</p>
    <div id="hornsShopDisplay" style="color:#f1c40f; font-size:24px; margin:10px;">
        üêÇ <span id="hornsShopCount">0</span> HORNS
    </div>
    <div class="upgrade-grid" id="upgradeGrid"></div>
    <button class="btn secondary" id="continueBtn">CONTINUE WAVE</button>
</div>

<!-- GAME OVER OVERLAY -->
<div id="gameOverOverlay" class="overlay" style="display:none;">
    <h1>SHOP CLOSED</h1>
    <h2 id="finalScore" style="color:#00f0ff;"></h2>
    <p id="rankText" style="font-size:16px; color:#f1c40f;"></p>
    
    <div style="margin:20px;">
        <a href="https://open.spotify.com/track/YOUR_TRACK_ID?utm_source=game" 
           target="_blank" class="stream-cta" id="spotifyLink">
            üéµ STREAM ON SPOTIFY
        </a>
        <a href="https://music.apple.com/us/album/YOUR_TRACK_ID" 
           target="_blank" class="stream-cta apple" id="appleLink">
            üéµ STREAM ON APPLE
        </a>
    </div>

    <div style="max-width:400px; margin:20px auto;">
        <p style="font-size:14px;">Enter your email to save your score & get notified of new music!</p>
        <input type="email" id="emailInput" placeholder="your@email.com">
        <div class="checkbox-container">
            <input type="checkbox" id="consentCheck" checked>
            <label for="consentCheck">Send me D RoC music updates</label>
        </div>
        <button class="btn" id="submitScoreBtn">SUBMIT SCORE</button>
    </div>

    <div id="leaderboard">
        <h3 style="color:#00f0ff; text-align:center;">üèÜ TOP SMASHERS THIS WEEK</h3>
        <div id="leaderboardList"></div>
    </div>

    <div style="margin:20px;">
        <button class="btn secondary" id="shareBtn">üì§ SHARE SCORE</button>
        <button class="btn" id="playAgainBtn">üîÑ PLAY AGAIN</button>
    </div>

    <div id="adOfferContainer" style="margin-top:20px; display:none;">
        <p style="color:#f1c40f;">Watch an ad to continue with your upgrades?</p>
        <button class="btn secondary" id="watchAdBtn">üì∫ WATCH & CONTINUE</button>
    </div>
</div>

<!-- VICTORY OVERLAY -->
<div id="victoryOverlay" class="overlay" style="display:none;">
    <h1>üèÜ SHOP SURVIVED!</h1>
    <h2 id="victoryScore"></h2>
    <p style="font-size:18px; color:#f1c40f;">YOU ARE THE ULTIMATE BULL!</p>
    <p>Endless mode unlocked!</p>
    <button class="btn primary" id="endlessBtn">‚ôæÔ∏è ENDLESS MODE</button>
    <button class="btn secondary" id="victoryShareBtn">üì§ SHARE VICTORY</button>
</div>

<script>
    // ===== CONFIGURATION =====
    const CONFIG = {
        FIREBASE_URL: 'https://YOUR-PROJECT.firebaseio.com/leaderboard.json',
        APPLIXIR_APP_ID: 'YOUR_APPLIXIR_APP_ID', // Get from applixir.com
        SPOTIFY_TRACK: 'YOUR_TRACK_ID',
        APPLE_TRACK: 'YOUR_TRACK_ID',
        SONG_URL: 'song.mp3', // Place in same folder
        LYRICS: [
            "DUMB BULL",
            "CRASHIN' THROUGH",
            "CHINA SHOP",
            "CAN'T STOP WON'T STOP",
            "SMASH IT ALL"
        ]
    };

    // ===== ANALYTICS HELPER =====
    function trackEvent(name, props = {}) {
        if (window.plausible) {
            window.plausible(name, { props });
        }
        console.log(`[Analytics] ${name}`, props);
    }

    // ===== AUDIO ENGINE =====
    const AudioEngine = {
        ctx: null,
        songBuffer: null,
        songSource: null,
        analyser: null,
        songPlaying: false,
        
        init: function() {
            window.AudioContext = window.AudioContext || window.webkitAudioContext;
            this.ctx = new AudioContext();
            this.analyser = this.ctx.createAnalyser();
            this.analyser.fftSize = 256;
            this.loadSong();
        },

        loadSong: function() {
            fetch(CONFIG.SONG_URL)
                .then(response => response.arrayBuffer())
                .then(data => this.ctx.decodeAudioData(data))
                .then(buffer => {
                    this.songBuffer = buffer;
                    console.log('Song loaded successfully');
                })
                .catch(err => {
                    console.warn('Song not found - procedural audio only', err);
                });
        },

        playSong: function() {
            if (!this.songBuffer || this.songPlaying) return;
            
            this.songSource = this.ctx.createBufferSource();
            this.songSource.buffer = this.songBuffer;
            this.songSource.loop = true;
            
            this.songSource.connect(this.analyser);
            this.analyser.connect(this.ctx.destination);
            
            this.songSource.start(0);
            this.songPlaying = true;
        },

        stopSong: function() {
            if (this.songSource) {
                this.songSource.stop();
                this.songSource = null;
                this.songPlaying = false;
            }
        },

        getBeatIntensity: function() {
            if (!this.analyser) return 0;
            const dataArray = new Uint8Array(this.analyser.frequencyBinCount);
            this.analyser.getByteFrequencyData(dataArray);
            
            // Focus on bass frequencies (0-4 bins)
            let bassSum = 0;
            for (let i = 0; i < 4; i++) {
                bassSum += dataArray[i];
            }
            return bassSum / 4 / 255; // Normalize 0-1
        },

        // Procedural SFX
        createOsc: function(type, freq, start, end, vol=0.1) {
            if(!this.ctx) return;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, start);
            gain.gain.setValueAtTime(vol, start);
            gain.gain.exponentialRampToValueAtTime(0.001, end);
            osc.connect(gain).connect(this.ctx.destination);
            osc.start(start);
            osc.stop(end);
        },

        smash: function() {
            if(!this.ctx) return;
            const t = this.ctx.currentTime;
            
            // Noise burst
            const bufferSize = this.ctx.sampleRate * 0.25;
            const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                data[i] = Math.random() * 2 - 1;
            }
            const noise = this.ctx.createBufferSource();
            noise.buffer = buffer;
            const filter = this.ctx.createBiquadFilter();
            filter.type = 'highpass';
            filter.frequency.setValueAtTime(1200, t);
            filter.frequency.exponentialRampToValueAtTime(80, t + 0.2);
            const gain = this.ctx.createGain();
            gain.gain.setValueAtTime(0.4, t);
            gain.gain.exponentialRampToValueAtTime(0.01, t + 0.25);
            noise.connect(filter).connect(gain).connect(this.ctx.destination);
            noise.start();
            
            // Bass thump
            this.createOsc('square', 65, t, t+0.15, 0.35);
        },

        collect: function() {
            if(!this.ctx) return;
            const t = this.ctx.currentTime;
            this.createOsc('sine', 1200, t, t+0.08, 0.12);
            this.createOsc('sine', 1800, t+0.04, t+0.15, 0.1);
        },

        dash: function() {
            if(!this.ctx) return;
            const t = this.ctx.currentTime;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(90, t);
            osc.frequency.linearRampToValueAtTime(550, t + 0.18);
            gain.gain.setValueAtTime(0.12, t);
            gain.gain.linearRampToValueAtTime(0, t + 0.18);
            osc.connect(gain).connect(this.ctx.destination);
            osc.start();
            osc.stop(t+0.18);
        },

        powerup: function() {
            if(!this.ctx) return;
            const t = this.ctx.currentTime;
            this.createOsc('sine', 400, t, t+0.1, 0.15);
            this.createOsc('sine', 600, t+0.05, t+0.15, 0.15);
            this.createOsc('sine', 800, t+0.1, t+0.2, 0.15);
        }
    };

    // ===== CANVAS SETUP =====
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d', { alpha: false });
    
    let width, height;
    let bgCanvas;

    function resize() {
        width = window.innerWidth;
        height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;
        preRenderBackground();
    }
    
    function preRenderBackground() {
        bgCanvas = document.createElement('canvas');
        bgCanvas.width = width;
        bgCanvas.height = height;
        const bCtx = bgCanvas.getContext('2d');

        // Dark Floor
        bCtx.fillStyle = '#0a0a0a';
        bCtx.fillRect(0, 0, width, height);

        // Animated Grid
        bCtx.strokeStyle = '#1a1a2e';
        bCtx.lineWidth = 1;
        const gridSize = 60;
        
        bCtx.beginPath();
        for (let x = 0; x <= width; x += gridSize) {
            bCtx.moveTo(x, 0); bCtx.lineTo(x, height);
        }
        for (let y = 0; y <= height; y += gridSize) {
            bCtx.moveTo(0, y); bCtx.lineTo(width, y);
        }
        bCtx.stroke();

        // Vignette
        const grad = bCtx.createRadialGradient(width/2, height/2, height*0.3, width/2, height/2, height*0.8);
        grad.addColorStop(0, 'rgba(0,0,0,0)');
        grad.addColorStop(1, 'rgba(0,0,0,0.7)');
        bCtx.fillStyle = grad;
        bCtx.fillRect(0,0,width,height);
    }

    window.addEventListener('resize', resize);

    // ===== GAME ENTITIES =====
    class Bull {
        constructor() {
            this.reset();
            this.upgrades = {
                speed: 1.0,
                dashCooldown: 800,
                magnet: false
            };
        }

        reset() {
            this.x = width/2;
            this.y = height/2;
            this.vx = 0;
            this.vy = 0;
            this.size = 35;
            this.angle = 0;
        }

        update(jx, jy) {
            const accel = 1.8 * this.upgrades.speed;
            this.vx += jx * accel;
            this.vy += jy * accel;
            
            this.vx *= 0.90;
            this.vy *= 0.90;
            
            this.x += this.vx;
            this.y += this.vy;
            
            // Screen wrap
            if(this.x < -this.size) this.x = width + this.size;
            if(this.x > width + this.size) this.x = -this.size;
            if(this.y < -this.size) this.y = height + this.size;
            if(this.y > height + this.size) this.y = -this.size;

            // Rotation
            if(Math.abs(this.vx) > 0.1 || Math.abs(this.vy) > 0.1) {
                this.angle = Math.atan2(this.vy, this.vx);
            }

            // Magnet upgrade
            if (this.upgrades.magnet) {
                gameState.targets.forEach(t => {
                    if (t.active) {
                        const dx = this.x - t.x;
                        const dy = this.y - t.y;
                        const dist = Math.hypot(dx, dy);
                        if (dist < 120 && dist > this.size + t.r) {
                            t.x += dx * 0.03;
                            t.y += dy * 0.03;
                        }
                    }
                });
            }
        }

        dash() {
            const speed = Math.hypot(this.vx, this.vy) || 1;
            this.vx = (this.vx/speed) * 40;
            this.vy = (this.vy/speed) * 40;
            gameState.shake = 12;
            AudioEngine.dash();
            
            // Trail
            for(let i=0; i<6; i++) {
                gameState.particles.push(new Particle(
                    this.x, this.y, '#ff0055', 
                    -this.vx*0.4, -this.vy*0.4
                ));
            }
        }

        draw() {
            ctx.save();
            ctx.translate(this.x, this.y);
            ctx.rotate(this.angle);

            // Glow
            const beatGlow = AudioEngine.getBeatIntensity() * 15;
            ctx.shadowColor = '#00f0ff';
            ctx.shadowBlur = 18 + beatGlow;

            // Body
            ctx.fillStyle = '#00f0ff';
            ctx.beginPath();
            ctx.moveTo(22, 0);
            ctx.lineTo(-16, 16);
            ctx.lineTo(-12, 0);
            ctx.lineTo(-16, -16);
            ctx.closePath();
            ctx.fill();

            // Horns
            ctx.fillStyle = '#ffffff';
            ctx.shadowBlur = 8;
            ctx.shadowColor = '#ffffff';
            ctx.beginPath();
            ctx.moveTo(12, 6); ctx.lineTo(28, 16); ctx.lineTo(12, 11);
            ctx.moveTo(12, -6); ctx.lineTo(28, -16); ctx.lineTo(12, -11);
            ctx.fill();

            // Eyes (angry)
            ctx.fillStyle = '#ff0055';
            ctx.shadowBlur = 5;
            ctx.shadowColor = '#ff0055';
            ctx.beginPath();
            ctx.arc(8, -4, 2, 0, Math.PI*2);
            ctx.arc(8, 4, 2, 0, Math.PI*2);
            ctx.fill();

            ctx.restore();
        }
    }

    class Target {
        constructor(type, waveNum = 1) {
            this.type = type; // 0 = china, 1 = golden apple
            this.waveNum = waveNum;
            this.moving = waveNum >= 4;
            this.mvx = 0;
            this.mvy = 0;
            this.respawn();
        }

        respawn() {
            this.active = true;
            this.r = this.type === 0 ? 28 : 18;
            this.x = Math.random() * (width - 120) + 60;
            this.y = Math.random() * (height - 120) + 60;
            this.polySides = Math.floor(Math.random() * 3) + 4;
            this.rot = Math.random() * Math.PI;
            
            if (this.moving) {
                const angle = Math.random() * Math.PI * 2;
                const speed = 0.5 + Math.random() * 1.5;
                this.mvx = Math.cos(angle) * speed;
                this.mvy = Math.sin(angle) * speed;
            }
        }

        update() {
            if (this.moving && this.active) {
                this.x += this.mvx;
                this.y += this.mvy;

                // Bounce off walls
                if (this.x < this.r || this.x > width - this.r) this.mvx *= -1;
                if (this.y < this.r || this.y > height - this.r) this.mvy *= -1;
            }

            this.rot += 0.01;
        }

        draw() {
            if(!this.active) return;

            // Beat pulse
            const beatPulse = AudioEngine.getBeatIntensity() * 5;

            ctx.save();
            ctx.translate(this.x, this.y);
            
            if (this.type === 0) {
                // China
                ctx.strokeStyle = '#ecf0f1';
                ctx.lineWidth = 3;
                ctx.shadowColor = '#ecf0f1';
                ctx.shadowBlur = 8 + beatPulse;
                ctx.rotate(this.rot);
                
                ctx.beginPath();
                for(let i=0; i<this.polySides; i++) {
                    const theta = (i / this.polySides) * Math.PI * 2;
                    const pr = this.r + beatPulse * 0.5;
                    const px = Math.cos(theta) * pr;
                    const py = Math.sin(theta) * pr;
                    if(i===0) ctx.moveTo(px, py);
                    else ctx.lineTo(px, py);
                }
                ctx.closePath();
                ctx.stroke();
                
                ctx.fillStyle = 'rgba(236, 240, 241, 0.15)';
                ctx.fill();

                // Ceramic pattern
                ctx.strokeStyle = 'rgba(52, 152, 219, 0.4)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.arc(0, 0, this.r * 0.5, 0, Math.PI*2);
                ctx.stroke();
            } else {
                // Golden Apple
                ctx.fillStyle = '#f1c40f';
                ctx.shadowColor = '#f1c40f';
                ctx.shadowBlur = 25 + beatPulse * 2;
                ctx.beginPath();
                ctx.arc(0, 0, this.r + beatPulse * 0.3, 0, Math.PI*2);
                ctx.fill();
                
                // Rotating aura
                ctx.strokeStyle = 'rgba(241, 196, 15, 0.6)';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(0, 0, this.r + Math.sin(Date.now()/80)*4, 0, Math.PI*2);
                ctx.stroke();

                // Horn symbol
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('üêÇ', 0, 0);
            }
            ctx.restore();
        }
    }

    class BossTarget {
        constructor() {
            this.active = true;
            this.hp = 10;
            this.maxHp = 10;
            this.r = 60;
            this.x = width / 2;
            this.y = height / 2;
            this.angle = 0;
        }

        hit() {
            this.hp--;
            gameState.shake = 20;
            
            if (this.hp <= 0) {
                this.active = false;
                // Massive explosion
                for (let i = 0; i < 30; i++) {
                    gameState.particles.push(new Particle(
                        this.x, this.y, 
                        ['#ecf0f1', '#f1c40f', '#e74c3c'][Math.floor(Math.random()*3)]
                    ));
                }
                // Big reward
                for (let i = 0; i < 5; i++) {
                    gameState.targets.push(new Target(1));
                }
            }
        }

        update() {
            this.angle += 0.02;
            
            // Orbit movement
            const t = Date.now() / 1000;
            this.x = width/2 + Math.cos(t * 0.5) * 150;
            this.y = height/2 + Math.sin(t * 0.5) * 150;
        }

        draw() {
            if (!this.active) return;

            ctx.save();
            ctx.translate(this.x, this.y);
            ctx.rotate(this.angle);

            // Outer shell
            ctx.strokeStyle = '#e74c3c';
            ctx.lineWidth = 5;
            ctx.shadowColor = '#e74c3c';
            ctx.shadowBlur = 30;
            
            ctx.beginPath();
            for (let i = 0; i < 8; i++) {
                const theta = (i / 8) * Math.PI * 2;
                const r = this.r + Math.sin(Date.now()/100 + i) * 8;
                const px = Math.cos(theta) * r;
                const py = Math.sin(theta) * r;
                if (i === 0) ctx.moveTo(px, py);
                else ctx.lineTo(px, py);
            }
            ctx.closePath();
            ctx.stroke();

            // HP bar
            ctx.fillStyle = 'rgba(0,0,0,0.5)';
            ctx.fillRect(-40, 80, 80, 8);
            ctx.fillStyle = '#e74c3c';
            const hpWidth = (this.hp / this.maxHp) * 80;
            ctx.fillRect(-40, 80, hpWidth, 8);

            ctx.restore();
        }
    }

    class Particle {
        constructor(x, y, color, vx, vy) {
            this.x = x;
            this.y = y;
            this.vx = vx || (Math.random() - 0.5) * 18;
            this.vy = vy || (Math.random() - 0.5) * 18;
            this.life = 1.0;
            this.color = color;
            this.size = Math.random() * 5 + 2;
        }

        update() {
            this.x += this.vx;
            this.y += this.vy;
            this.vx *= 0.94;
            this.vy *= 0.94;
            this.life -= 0.025;
        }

        draw() {
            ctx.globalAlpha = this.life;
            ctx.fillStyle = this.color;
            ctx.globalCompositeOperation = 'lighter';
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI*2);
            ctx.fill();
            ctx.globalCompositeOperation = 'source-over';
            ctx.globalAlpha = 1.0;
        }
    }

    // ===== GAME STATE =====
    const gameState = {
        player: new Bull(),
        targets: [],
        boss: null,
        particles: [],
        score: 0,
        streak: 0,
        horns: 0,
        wave: 1,
        waveTime: 45,
        waveTimer: null,
        running: false,
        paused: false,
        shake: 0,
        endless: false,
        deaths: 0,
        lastLyricTime: 0
    };

    const UPGRADES = {
        speed: {
            name: 'Speed Boost',
            desc: '+25% Movement Speed',
            cost: 200,
            owned: false,
            apply: () => { gameState.player.upgrades.speed = 1.25; }
        },
        dash: {
            name: 'Fast Dash',
            desc: 'Dash Cooldown -40%',
            cost: 300,
            owned: false,
            apply: () => { gameState.player.upgrades.dashCooldown = 480; }
        },
        magnet: {
            name: 'Bull Magnet',
            desc: 'Auto-attract nearby items',
            cost: 400,
            owned: false,
            apply: () => { gameState.player.upgrades.magnet = true; }
        }
    };

    // ===== WAVE MANAGEMENT =====
    function initWave(waveNum) {
        gameState.wave = waveNum;
        gameState.waveTime = 45;
        gameState.streak = 0;
        gameState.targets = [];

        document.getElementById('waveNum').innerText = waveNum;
        
        // Scale difficulty
        const baseCount = 8;
        const count = baseCount + (waveNum - 1) * 2;
        
        for (let i = 0; i < count; i++) {
            gameState.targets.push(new Target(0, waveNum));
        }

        // Boss wave
        if (waveNum === 5) {
            gameState.boss = new BossTarget();
        }

        startWaveTimer();
    }

    function startWaveTimer() {
        if (gameState.waveTimer) clearInterval(gameState.waveTimer);
        
        gameState.waveTimer = setInterval(() => {
            if (gameState.paused) return;
            
            gameState.waveTime--;
            document.getElementById('waveTimer').innerText = gameState.waveTime + 's';
            
            if (gameState.waveTime <= 0) {
                completeWave();
            }
        }, 1000);
    }

    function completeWave() {
        clearInterval(gameState.waveTimer);
        gameState.paused = true;
        
        trackEvent('wave_complete', { wave: gameState.wave, score: gameState.score });

        if (gameState.wave >= 5) {
            // Victory!
            showVictory();
        } else {
            // Show shop
            showShop();
        }
    }

    function showWaveTransition(text, subtext) {
        const overlay = document.getElementById('waveTransition');
        document.getElementById('waveTransText').innerText = text;
        document.getElementById('waveTransSubtext').innerText = subtext;
        overlay.style.display = 'flex';
        
        setTimeout(() => {
            overlay.style.display = 'none';
        }, 2000);
    }

    // ===== SHOP SYSTEM =====
    function showShop() {
        AudioEngine.stopSong();
        document.getElementById('hornsShopCount').innerText = gameState.horns;
        
        const grid = document.getElementById('upgradeGrid');
        grid.innerHTML = '';
        
        Object.entries(UPGRADES).forEach(([key, upgrade]) => {
            const card = document.createElement('div');
            card.className = 'upgrade-card' + (upgrade.owned ? ' owned' : '');
            card.innerHTML = `
                <h3>${upgrade.name}</h3>
                <p>${upgrade.desc}</p>
                <div class="price">üêÇ ${upgrade.cost}</div>
            `;
            
            if (!upgrade.owned) {
                card.style.cursor = 'pointer';
                card.onclick = () => buyUpgrade(key, upgrade);
            }
            
            grid.appendChild(card);
        });
        
        document.getElementById('shopOverlay').style.display = 'flex';
    }

    function buyUpgrade(key, upgrade) {
        if (upgrade.owned || gameState.horns < upgrade.cost) {
            return;
        }
        
        gameState.horns -= upgrade.cost;
        upgrade.owned = true;
        upgrade.apply();
        
        AudioEngine.powerup();
        trackEvent('upgrade_purchased', { upgrade: key });
        
        document.getElementById('hornsShopCount').innerText = gameState.horns;
        showShop(); // Refresh
    }

    document.getElementById('continueBtn').onclick = () => {
        document.getElementById('shopOverlay').style.display = 'none';
        gameState.paused = false;
        
        const nextWave = gameState.wave + 1;
        showWaveTransition(`WAVE ${nextWave}`, 'INCOMING!');
        
        setTimeout(() => {
            initWave(nextWave);
            AudioEngine.playSong();
        }, 2000);
    };

    // ===== GAME LOOP =====
    function loop() {
        if (!gameState.running || gameState.paused) {
            requestAnimationFrame(loop);
            return;
        }

        // Clear & background
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        
        if (gameState.shake > 0) {
            ctx.translate(
                (Math.random() - 0.5) * gameState.shake,
                (Math.random() - 0.5) * gameState.shake
            );
            gameState.shake *= 0.88;
            if (gameState.shake < 0.5) gameState.shake = 0;
        }
        
        ctx.drawImage(bgCanvas, 0, 0);

        // Player
        gameState.player.update(joyX, joyY);
        gameState.player.draw();

        // Boss
        if (gameState.boss && gameState.boss.active) {
            gameState.boss.update();
            gameState.boss.draw();

            const dx = gameState.player.x - gameState.boss.x;
            const dy = gameState.player.y - gameState.boss.y;
            const dist = Math.hypot(dx, dy);
            
            if (dist < gameState.player.size + gameState.boss.r) {
                gameState.boss.hit();
                AudioEngine.smash();
                gameState.score += 500;
                updateUI();
            }
        }

        // Targets
        gameState.targets.forEach(t => {
            t.update();
            t.draw();
            
            if (t.active) {
                const dx = gameState.player.x - t.x;
                const dy = gameState.player.y - t.y;
                const dist = Math.hypot(dx, dy);
                
                if (dist < gameState.player.size + t.r) {
                    t.active = false;
                    
                    if (t.type === 0) {
                        // Smash china
                        AudioEngine.smash();
                        gameState.shake = 14;
                        gameState.streak++;
                        gameState.score += 50 * gameState.streak;
                        
                        showCombo();
                        showLyric();
                        
                        for (let i = 0; i < 10; i++) {
                            gameState.particles.push(new Particle(t.x, t.y, '#ecf0f1'));
                        }
                        
                        // Chance for golden apple
                        if (Math.random() > 0.75) {
                            gameState.targets.push(new Target(1, gameState.wave));
                        }
                        
                        setTimeout(() => t.respawn(), 1000);
                    } else {
                        // Collect apple
                        AudioEngine.collect();
                        gameState.score += 500;
                        gameState.horns += 100;
                        
                        for (let i = 0; i < 15; i++) {
                            gameState.particles.push(new Particle(t.x, t.y, '#f1c40f'));
                        }
                    }
                    
                    updateUI();
                }
            }
        });

        // Particles
        for (let i = gameState.particles.length - 1; i >= 0; i--) {
            const p = gameState.particles[i];
            p.update();
            p.draw();
            if (p.life <= 0) gameState.particles.splice(i, 1);
        }

        // Streak decay
        if (gameState.streak > 0 && Math.random() < 0.004) {
            gameState.streak = Math.max(0, gameState.streak - 1);
            updateUI();
        }

        requestAnimationFrame(loop);
    }

    function updateUI() {
        document.getElementById('scoreVal').innerText = gameState.score;
        document.getElementById('streakVal').innerText = 'x' + gameState.streak;
        document.getElementById('hornsCount').innerText = gameState.horns;
    }

    function showCombo() {
        const phrases = ["SMASH!", "CRUSH!", "WRECK!", "BOOM!", "DESTROYED!"];
        const comboEl = document.getElementById('comboTxt');
        comboEl.innerText = phrases[Math.floor(Math.random() * phrases.length)] + 
                          (gameState.streak > 1 ? ' x' + gameState.streak : '');
        comboEl.style.opacity = 1;
        comboEl.style.transform = "translate(-50%, -50%) scale(1.4)";
        
        setTimeout(() => {
            comboEl.style.opacity = 0;
            comboEl.style.transform = "translate(-50%, -50%) scale(1.0)";
        }, 600);
    }

    function showLyric() {
        const now = Date.now();
        if (now - gameState.lastLyricTime < 3000) return; // Cooldown
        
        if (gameState.streak >= 5 && gameState.streak % 5 === 0) {
            const lyric = CONFIG.LYRICS[Math.floor(Math.random() * CONFIG.LYRICS.length)];
            const lyricEl = document.getElementById('lyricFlash');
            lyricEl.innerText = lyric;
            lyricEl.style.opacity = 1;
            
            gameState.lastLyricTime = now;
            
            setTimeout(() => {
                lyricEl.style.opacity = 0;
            }, 2000);
        }
    }

    // ===== CONTROLS =====
    let joyX = 0, joyY = 0;
    const joyOuter = document.getElementById('joystickOuter');
    const joyInner = document.getElementById('joystickInner');
    
    const handleJoy = (e) => {
        e.preventDefault();
        const touch = e.touches ? e.touches[0] : e;
        const rect = joyOuter.getBoundingClientRect();
        const centerX = rect.left + rect.width/2;
        const centerY = rect.top + rect.height/2;
        let dx = touch.clientX - centerX;
        let dy = touch.clientY - centerY;
        const dist = Math.min(Math.hypot(dx, dy), rect.width/2);
        const angle = Math.atan2(dy, dx);
        joyX = Math.cos(angle) * (dist/(rect.width/2));
        joyY = Math.sin(angle) * (dist/(rect.width/2));
        
        const uiDist = Math.min(dist, (rect.width/2)-30);
        joyInner.style.transform = `translate(calc(-50% + ${Math.cos(angle)*uiDist}px), calc(-50% + ${Math.sin(angle)*uiDist}px))`;
    };
    
    const resetJoy = () => {
        joyX = 0;
        joyY = 0;
        joyInner.style.transform = 'translate(-50%, -50%)';
    };

    joyOuter.addEventListener('touchstart', handleJoy, {passive: false});
    joyOuter.addEventListener('touchmove', handleJoy, {passive: false});
    joyOuter.addEventListener('touchend', resetJoy);
    joyOuter.addEventListener('mousedown', handleJoy);
    joyOuter.addEventListener('mousemove', (e) => {
        if (e.buttons === 1) handleJoy(e);
    });
    joyOuter.addEventListener('mouseup', resetJoy);
    joyOuter.addEventListener('mouseleave', resetJoy);

    // Dash
    const dashBtn = document.getElementById('dashBtn');
    let canDash = true;
    
    const performDash = (e) => {
        e.preventDefault();
        if (gameState.running && !gameState.paused && canDash) {
            gameState.player.dash();
            canDash = false;
            dashBtn.classList.add('cooldown');
            
            setTimeout(() => {
                canDash = true;
                dashBtn.classList.remove('cooldown');
            }, gameState.player.upgrades.dashCooldown);
        }
    };
    
    dashBtn.addEventListener('touchstart', performDash);
    dashBtn.addEventListener('mousedown', performDash);

    // ===== GAME OVER =====
    function gameOver() {
        gameState.running = false;
        gameState.deaths++;
        clearInterval(gameState.waveTimer);
        AudioEngine.stopSong();
        
        trackEvent('game_over', { 
            score: gameState.score, 
            wave: gameState.wave,
            deaths: gameState.deaths
        });

        document.getElementById('finalScore').innerText = `${gameState.score.toLocaleString()} POINTS`;
        
        // Show ad offer if eligible (not first death)
        if (gameState.deaths > 1 && gameState.deaths % 3 === 0) {
            document.getElementById('adOfferContainer').style.display = 'block';
        }
        
        loadLeaderboard();
        document.getElementById('gameOverOverlay').style.display = 'flex';
    }

    function showVictory() {
        gameState.running = false;
        clearInterval(gameState.waveTimer);
        AudioEngine.stopSong();
        
        trackEvent('game_victory', { score: gameState.score });
        
        document.getElementById('victoryScore').innerText = 
            `FINAL SCORE: ${gameState.score.toLocaleString()}`;
        document.getElementById('victoryOverlay').style.display = 'flex';
    }

    // ===== LEADERBOARD (Firebase) =====
    async function loadLeaderboard() {
        try {
            const response = await fetch(CONFIG.FIREBASE_URL);
            const data = await response.json();
            
            if (!data) {
                document.getElementById('leaderboardList').innerHTML = 
                    '<div class="lb-entry">No scores yet. Be the first!</div>';
                return;
            }
            
            const entries = Object.values(data)
                .sort((a, b) => b.score - a.score)
                .slice(0, 10);
            
            const listHTML = entries.map((entry, i) => {
                const medal = ['ü•á', 'ü•à', 'ü•â'][i] || `#${i+1}`;
                return `
                    <div class="lb-entry">
                        <span>${medal} ${entry.email.split('@')[0]}</span>
                        <span>${entry.score.toLocaleString()}</span>
                    </div>
                `;
            }).join('');
            
            document.getElementById('leaderboardList').innerHTML = listHTML;
            
            // Show rank
            const userRank = entries.findIndex(e => e.score < gameState.score) + 1 || entries.length + 1;
            document.getElementById('rankText').innerText = 
                userRank <= 10 ? `You're Top 10!` : `You ranked #${userRank} this week`;
        } catch (err) {
            console.error('Leaderboard load failed:', err);
            document.getElementById('leaderboardList').innerHTML = 
                '<div class="lb-entry">Leaderboard unavailable</div>';
        }
    }

    document.getElementById('submitScoreBtn').onclick = async () => {
        const email = document.getElementById('emailInput').value;
        const consent = document.getElementById('consentCheck').checked;
        
        if (!email || !email.includes('@')) {
            alert('Please enter a valid email');
            return;
        }
        
        try {
            await fetch(CONFIG.FIREBASE_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email,
                    score: gameState.score,
                    wave: gameState.wave,
                    timestamp: Date.now(),
                    consent
                })
            });
            
            trackEvent('email_submitted', { score: gameState.score });
            alert('Score submitted! Check your email for updates üêÇ');
            loadLeaderboard();
        } catch (err) {
            console.error('Score submit failed:', err);
            alert('Failed to submit. Try again!');
        }
    };

    // ===== SOCIAL SHARING =====
    document.getElementById('shareBtn').onclick = () => {
        const shareText = `I just smashed ${gameState.score.toLocaleString()} points in Dumb Bull! üêÇüè∫ Can you beat me?`;
        const shareUrl = window.location.href + `?ref=player_${gameState.score}`;
        
        if (navigator.share) {
            navigator.share({
                title: 'Dumb Bull in a China Shop',
                text: shareText,
                url: shareUrl
            }).then(() => {
                trackEvent('share_clicked', { score: gameState.score });
            });
        } else {
            // Fallback: copy to clipboard
            navigator.clipboard.writeText(shareUrl).then(() => {
                alert('Link copied! Share it with friends üêÇ');
                trackEvent('share_clicked', { score: gameState.score, method: 'clipboard' });
            });
        }
    };

    document.getElementById('victoryShareBtn').onclick = document.getElementById('shareBtn').onclick;

    // ===== STREAM CTAs =====
    document.getElementById('spotifyLink').onclick = () => {
        trackEvent('stream_clicked', { platform: 'spotify' });
    };
    document.getElementById('appleLink').onclick = () => {
        trackEvent('stream_clicked', { platform: 'apple' });
    };

    // ===== REWARDED ADS =====
    document.getElementById('watchAdBtn').onclick = () => {
        if (typeof AdPlayer !== 'undefined') {
            const adConfig = {
                zoneId: CONFIG.APPLIXIR_APP_ID,
                accountId: CONFIG.APPLIXIR_APP_ID,
                gameId: CONFIG.APPLIXIR_APP_ID,
                adStatusCb: (status) => {
                    if (status === 'ad-watched') {
                        // Reward: Continue with upgrades
                        document.getElementById('gameOverOverlay').style.display = 'none';
                        gameState.running = true;
                        gameState.paused = false;
                        gameState.player.reset();
                        AudioEngine.playSong();
                        trackEvent('ad_watched', { result: 'continue' });
                    }
                }
            };
            AdPlayer.startPreRoll(adConfig);
        } else {
            alert('Ad SDK not loaded. Continuing anyway!');
            document.getElementById('gameOverOverlay').style.display = 'none';
            gameState.running = true;
        }
    };

    // ===== RESTART =====
    document.getElementById('playAgainBtn').onclick = () => {
        document.getElementById('gameOverOverlay').style.display = 'none';
        startGame();
    };

    document.getElementById('endlessBtn').onclick = () => {
        gameState.endless = true;
        document.getElementById('victoryOverlay').style.display = 'none';
        gameState.wave = 1;
        gameState.waveTime = 99999; // No timer
        initWave(1);
        gameState.running = true;
        gameState.paused = false;
        AudioEngine.playSong();
        loop();
    };

    // ===== START =====
    function startGame() {
        // Reset
        gameState.score = 0;
        gameState.streak = 0;
        gameState.horns = 0;
        gameState.wave = 1;
        gameState.particles = [];
        gameState.boss = null;
        gameState.endless = false;
        gameState.player.reset();
        
        // Reset upgrades
        Object.values(UPGRADES).forEach(u => u.owned = false);
        gameState.player.upgrades = {
            speed: 1.0,
            dashCooldown: 800,
            magnet: false
        };
        
        updateUI();
        initWave(1);
        
        gameState.running = true;
        gameState.paused = false;
        
        AudioEngine.playSong();
        trackEvent('game_start');
        loop();
    }

    document.getElementById('startBtn').onclick = () => {
        AudioEngine.init();
        document.getElementById('startOverlay').style.display = 'none';
        startGame();
    };

    // ===== INIT =====
    resize();
    
    // Track page view
    trackEvent('page_view');
</script>
```

</body>
</html>